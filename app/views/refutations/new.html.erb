<h1><%= @agenda_board_agenda %></h1>
<div class="create_new_refutation">
  <div class="rebuttal_target_argument" id="argument<%= @rebuttal_target_conclusion_index %>">
    <h3 class="type_of_opinion">反論対象の主張</h3>
    <div class="tree_structure">
      <div class="conclusion box" id="conclusion<%= @rebuttal_target_conclusion_index %>">
        <h3>結論</h3>
        <div class="inner">
          <%= @rebuttal_target_conclusion.conclusion_summary %>
        </div>
        <h3>結論詳細</h3>
        <div class="inner">
          <%= @rebuttal_target_conclusion.conclusion_detail %>
        </div>
      </div>

      <div class="bases">
        <% @rebuttal_target_conclusion.reasons.each_with_index do |reason, r_i| %>
          <div class="basis">
            <div class="endpoint endpoint_between_conclusion<%= @rebuttal_target_conclusion_index %>_and_reason" id="endpoint_between_conclusion<%= @rebuttal_target_conclusion_index %>_and_reason<%= r_i %>_of_conclusion<%= @rebuttal_target_conclusion_index %>"></div>
            <div class="reason box reason_of_conclusion<%= @rebuttal_target_conclusion_index %>" id="reason<%= r_i %>_of_conclusion<%= @rebuttal_target_conclusion_index %>">
              <h3>理由</h3>
              <div class="inner">
                <%= reason.reason_summary %>
              </div>
              <h3>理由詳細</h3>
              <div class="inner">
                <%= reason.reason_detail %>
              </div>
            </div>

            <div class="evidences">
              <% reason.evidences.each_with_index do |evidence, e_i| %>
                <div class="evidence">
                  <div class="endpoint endpoint_between_reason<%= r_i %>_of_conclusion<%= @rebuttal_target_conclusion_index %>_and_evidence" id="endpoint_between_reason<%= r_i %>_of_conclusion<%= @rebuttal_target_conclusion_index %>_and_evidence<%= e_i %>_of_reason<%= r_i %>_of_conclusion<%= @rebuttal_target_conclusion_index %>"></div>
                  <div class="evidence box evidence_of_reason<%= r_i %>_of_conclusion<%= @rebuttal_target_conclusion_index %>" id="evidence<%= e_i %>_of_reason<%= r_i %>_of_conclusion<%= @rebuttal_target_conclusion_index %>">
                    <h3>証拠</h3>
                    <div class="inner">
                      <%= evidence.evidence_summary %>
                    </div>
                    <h3>証拠詳細</h3>
                    <div class="inner">
                      <%= evidence.evidence_detail %>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <div class="create_new_refutation_form">
    <h2>新規反論</h2>
    <%= form_with model: @ref_conclusion, url: refutations_path, local: true do |ref_conclusion_form| %>
      <%= ref_conclusion_form.hidden_field :agenda_board_id, value: @agenda_board_id %>
      <%= ref_conclusion_form.label :ref_conclusion_summary, "結論" %>
      <%= ref_conclusion_form.text_field :ref_conclusion_summary %>
      <%= ref_conclusion_form.label :ref_conclusion_detail, "結論詳細" %>
      <%= ref_conclusion_form.text_area :ref_conclusion_detail %>

      <div class="nested_ref_bases_forms">
        <%= ref_conclusion_form.fields_for :ref_reasons do |nested_ref_reason_form| %>
          <div class="nested-fields">
            <%= nested_ref_reason_form.label :ref_reason_summary, "理由" %>
            <%= nested_ref_reason_form.text_field :ref_reason_summary %>
            <%= nested_ref_reason_form.label :ref_reason_detail, "理由詳細" %>
            <%= nested_ref_reason_form.text_area :ref_reason_detail %>
            <%= link_to_remove_association "理由を削除", nested_ref_reason_form %>

            <div class="nested_ref_evidences_forms">
              <%= nested_ref_reason_form.fields_for :ref_evidences do |nested_ref_evidence_form| %>
                <div class="nested-fields">
                  <%= nested_ref_evidence_form.label :ref_evidence_summary, "証拠" %>
                  <%= nested_ref_evidence_form.text_field :ref_evidence_summary %>
                  <%= nested_ref_evidence_form.label :ref_evidence_detail, "証拠詳細" %>
                  <%= nested_ref_evidence_form.text_area :ref_evidence_detail %>
                  <%= link_to_remove_association "証拠を削除", nested_ref_evidence_form %>
                </div>
              <% end %>
            </div>

            <div class="add_nested_ref_evidence_form">
              <%= link_to_add_association "証拠を追加", nested_ref_reason_form, :ref_evidences, data: { association_insertion_method: 'after' } %>
            </div>
          </div>
        <% end %>

        <div class="add_nested_ref_reason_form">
          <%= link_to_add_association "理由を追加", ref_conclusion_form, :ref_reasons %>
        </div>
      </div>
      <div>
        <%= ref_conclusion_form.submit "新規反論を作成する" %>
      </div>
    <% end %>
  </div>
</div>
<script
src="https://code.jquery.com/jquery-3.5.1.min.js"
integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsPlumb/2.14.3/js/jsplumb.min.js"></script>
<%= javascript_pack_tag 'rebuttal_target_argument' %>
